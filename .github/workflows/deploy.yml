name: Production CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # JOB 1: Continuous Integration (Security & Quality Checks)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 bandit safety
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

      - name: üîç Lint with Flake8 (Check Syntax)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: üõ°Ô∏è Security Scan (Bandit)
        run: bandit -r backend/ -ll -ii

      - name: üì¶ Check Dependencies (Safety)
        run: safety check

  # JOB 2: Continuous Deployment
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          set -e
          
          echo "üöÄ Starting Deployment..."
          
          # === 1. SMART CLONE/UPDATE ===
          # Check if the folder exists. If NOT, clone it.
          if [ ! -d "/home/ubuntu/ProTodo-App" ]; then
            echo "üìÇ Repo not found. Cloning for the first time..."
            git clone https://github.com/neyo55/ProTodo-App.git /home/ubuntu/ProTodo-App
            cd /home/ubuntu/ProTodo-App
          else
            echo "‚¨áÔ∏è Repo exists. Pulling latest changes..."
            cd /home/ubuntu/ProTodo-App
            git fetch origin main
            git reset --hard origin/main
          fi

          # === 2. Update Configurations ===
          echo "‚öôÔ∏è Updating configurations..."
          # Fix permissions just in case
          chmod +x deployment/protodo.service
          
          # --- YOUR FIX: Grant Nginx Permission to Read Files ---
          echo "üîì Fixing permissions for Nginx..."
          # Allow 'others' (including Nginx) to enter these folders
          chmod 755 /home/ubuntu
          chmod 755 /home/ubuntu/ProTodo-App
          chmod 755 /home/ubuntu/ProTodo-App/frontend
          
          sudo cp deployment/protodo.service /etc/systemd/system/protodo.service
          sudo systemctl daemon-reload
          
          sudo cp deployment/nginx_protodo /etc/nginx/sites-available/protodo

          # 3. Disable Default Nginx Config (THE FIX)
          if [ -f /etc/nginx/sites-enabled/default ]; then
             sudo rm /etc/nginx/sites-enabled/default
             echo "üóëÔ∏è Removed default Nginx config"
          fi
          
          # 4. Enable ProTodo Config
          if [ ! -f /etc/nginx/sites-enabled/protodo ]; then
             sudo ln -s /etc/nginx/sites-available/protodo /etc/nginx/sites-enabled/
          fi
          sudo nginx -t

          # === 3. Install Dependencies ===
          echo "üì¶ Installing dependencies..."
          cd backend
          if [ ! -d "protodo" ]; then python3 -m venv protodo; fi
          source protodo/bin/activate
          pip install -r requirements.txt

          # === 4. Restart Services ===
          echo "cw Restarting Application..."
          sudo systemctl restart protodo
          sudo systemctl reload nginx
          
          echo "‚úÖ Production Deployment Complete!"










# name: Production CI/CD Pipeline

# on:
#   push:
#     branches:
#       - main

# jobs:
#   # JOB 1: Continuous Integration (Security & Quality Checks)
#   build-and-test:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v3

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.10'

#       - name: Install Dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install flake8 bandit safety
#           if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

#       - name: üîç Lint with Flake8 (Check Syntax)
#         # Stop the build if there are Python syntax errors or undefined names
#         run: |
#           # E9,F63,F7,F82 = Syntax errors
#           flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
#           # Warning for style (won't stop build, just warns)
#           flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

#       - name: üõ°Ô∏è Security Scan (Bandit)
#         # Checks for common security issues in Python code
#         run: |
#           bandit -r backend/ -ll -ii

#       - name: üì¶ Check Dependencies (Safety)
#         # Checks if installed packages have known security vulnerabilities
#         run: |
#           safety check

#   # JOB 2: Continuous Deployment (Only runs if Job 1 succeeds)
#   deploy:
#     needs: build-and-test  # <--- This is the Gatekeeper
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Deploy to EC2 via SSH
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.EC2_HOST }}
#         username: ${{ secrets.EC2_USER }}
#         key: ${{ secrets.EC2_KEY }}
#         script: |
#           set -e
#           set -o pipefail
          
#           echo "üöÄ Starting Deployment..."
          
#           # 1. Update Code
#           cd ~/ProTodo-App
#           git fetch origin main
#           git reset --hard origin/main

#           # 2. Update Configurations
#           echo "‚öôÔ∏è Updating configurations..."
#           sudo cp deployment/protodo.service /etc/systemd/system/protodo.service
#           sudo systemctl daemon-reload
#           sudo cp deployment/nginx_protodo /etc/nginx/sites-available/protodo
#           sudo ln -sf /etc/nginx/sites-available/protodo /etc/nginx/sites-enabled/
#           sudo nginx -t

#           # 3. Install Dependencies
#           echo "üì¶ Installing dependencies..."
#           cd backend
#           if [ ! -d "todo" ]; then python3 -m venv todo; fi
#           source todo/bin/activate
#           pip install -r requirements.txt

#           # 4. Restart Services
#           echo "cw Restarting Application..."
#           sudo systemctl restart protodo
#           sudo systemctl reload nginx
          
#           echo "‚úÖ Production Deployment Complete!"